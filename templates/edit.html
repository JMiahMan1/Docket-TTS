<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Edit Normalized Text - Docket-TTS</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
        rel="stylesheet">
</head>
<body class="bg-light">
    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-lg-10 col-md-12">

                <div class="card shadow-lg border-0 rounded-3">
                    <div class="card-body p-4">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h1 class="mb-0">üìù Edit & Regenerate</h1>
                            <a href="{{ url_for('list_files') }}" class="btn btn-secondary">‚Üê Back to Files</a>
                        </div>
                        
                        <p>You are editing the pre-normalized text for <strong>{{ base_name }}.mp3</strong>. Any changes made here will bypass the standard normalization process and be sent directly to the speech synthesizer.</p>

                        <form method="post">
                            <div class="mb-3">
                                <label for="edited_text" class="form-label">Normalized Text:</label>
                                <textarea class="form-control" id="edited_text" name="edited_text" rows="20">{{ text_content }}</textarea>
                            </div>

                            <hr class="my-4">
                            
                            <h4 class="mb-3">Regeneration Options</h4>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="voice" class="form-label">Select Voice:</label>
                                        <div class="input-group">
                                            <select class="form-select" id="voice" name="voice">
                                                {% if voices %}
                                                    {% for v in voices %}
                                                        <option value="{{ v.id }}" {% if v.id == 'af_bella' %}selected{% endif %}>{{ v.name }}</option>
                                                    {% endfor %}
                                                {% else %}
                                                    <option value="" disabled>Loading voices...</option>
                                                {% endif %}
                                            </select>
                                            <button class="btn btn-outline-secondary" type="button" id="speakSampleBtn">
                                                üîä Sample
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="speed_rate" class="form-label">Speech Speed: <span id="speed-value" class="fw-bold">Normal (1.00x)</span></label>
                                        <input type="range" class="form-range" id="speed_rate" name="speed_rate" min="0.7" max="1.4" step="0.05" value="1.0">
                                        <div class="d-flex justify-content-between">
                                            <small class="text-muted">Faster</small>
                                            <small class="text-muted">Slower</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-4" id="sampleContainer" style="display:none;">
                                <h5>Voice Sample</h5>
                                <audio id="sampleAudio" controls></audio>
                            </div>

                            <button type="submit" class="btn btn-primary w-100 mt-4">Save & Regenerate MP3</button>
                        </form>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    document.getElementById("speakSampleBtn").addEventListener("click", function() {
        const voiceSelect = document.getElementById("voice");
        if (!voiceSelect.value) {
            alert("Please select a voice first.");
            return;
        }
        const voiceId = voiceSelect.value;
        const speedRate = document.getElementById("speed_rate").value;
        const audio = document.getElementById("sampleAudio");
        const container = document.getElementById("sampleContainer");
        audio.src = `/speak_sample/${encodeURIComponent(voiceId)}?speed=${speedRate}`;
        container.style.display = "block";
        audio.play();
    });

    function updateSpeedValue(value) {
        const speedDisplay = document.getElementById('speed-value');
        const speed = (1 / parseFloat(value)).toFixed(2); 
        let label = `(${speed}x)`;
        if (speed > 0.95 && speed < 1.05) {
            label = `Normal ${label}`;
        } else if (speed > 1) {
            label = `Faster ${label}`;
        } else {
            label = `Slower ${label}`;
        }
        speedDisplay.textContent = label;
    }

    const speedSlider = document.getElementById('speed_rate');

    speedSlider.addEventListener('input', function() {
        updateSpeedValue(this.value);
    });
    
    updateSpeedValue(speedSlider.value);
    </script>
</body>
</html>
