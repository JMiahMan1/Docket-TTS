<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Generated Files - Docket-TTS</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body class="bg-light">
    <div class="container py-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="mb-0">ðŸ“¦ Generated Files</h1>
            <div>
                <a href="/jobs" class="btn btn-info"><i class="fas fa-tasks"></i> View Running Jobs</a>
                <a href="/" class="btn btn-secondary"><i class="fas fa-arrow-left"></i> Back to Upload</a>
            </div>
        </div>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% for category, message in messages %}
              <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
              </div>
            {% endfor %}
        {% endwith %}

        <div class="card shadow-sm border-0 rounded-3">
            <div class="card-header bg-dark text-white"><h4 class="mb-0">ðŸ”Š Audio Files</h4></div>
            <div class="card-body">
                {% if audio_files %}
                <div class="table-responsive">
                    <form id="mainForm" method="POST">
                        <table class="table table-striped table-hover align-middle">
                            <thead>
                                <tr>
                                    <th style="width: 3%;"><input class="form-check-input" type="checkbox" id="selectAll"></th>
                                    <th>Audio File (.mp3 / .m4b)</th>
                                    <th>Size</th>
                                    <th>Text File Actions</th>
                                    <th>Creation Date</th>
                                    <th style="width: 5%;">Delete</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for file in audio_files %}
                                <tr>
                                    <td><input class="form-check-input file-checkbox" type="checkbox" name="files_to_merge" value="{{ file.audio_name }}"></td>
                                    <td><a href="{{ url_for('download_file', name=file.audio_name) }}">{{ file.audio_name }}</a></td>
                                    <td><span class="text-muted">{{ file.size }}</span></td>
                                    <td>
                                        {% if file.txt_name %}
                                            <div class="btn-group" role="group">
                                                <a href="{{ url_for('download_file', name=file.txt_name) }}" class="btn btn-outline-secondary btn-sm" title="Download Text"><i class="fas fa-file-alt"></i> Download</a>
                                                <a href="{{ url_for('edit_text_page', text_filename=file.txt_name) }}" class="btn btn-outline-info btn-sm" title="Edit Text"><i class="fas fa-edit"></i> Edit</a>
                                            </div>
                                        {% else %}
                                            <span class="text-muted">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td data-utc-date="{{ file.date }}">Loading...</td>
                                    <td><input class="form-check-input delete-checkbox" type="checkbox" name="files_to_delete" value="{{ file.audio_name }}"></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </form>
                </div>
                <div class="d-flex gap-2 mt-3">
                    <button type="button" class="btn btn-primary" id="createAudiobookBtn"><i class="fas fa-book"></i> Create Audiobook from Selected</button>
                    <button type="button" class="btn btn-danger" id="deleteBtn"><i class="fas fa-trash"></i> Delete Selected Items</button>
                </div>
                {% else %}
                <p class="text-center text-muted">No audio files generated yet.</p>
                {% endif %}
            </div>
             <div class="card-footer text-center d-flex justify-content-between align-items-center">
                <div>
                    <a href="/">New Conversion</a> |
                    <a href="/jobs">View Running Jobs</a> |
                    <a href="/debug">Debug</a>
                </div>
                <small class="text-muted">v{{ app_version }}</small>
            </div>
        </div>
    </div>

    <div class="modal fade" id="audiobookModal" tabindex="-1" aria-labelledby="audiobookModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="audiobookModalLabel">Audiobook Details</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="text-center mb-3" id="metadataSpinner">
                <div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div>
                <p class="text-muted">Fetching metadata...</p>
            </div>
            <div id="metadataForm" style="display:none;">
                <div class="text-center mb-3">
                    <img id="audiobookCover" src="" class="img-thumbnail" style="max-height: 150px; display: none;">
                </div>
                <div class="mb-3">
                  <label for="audiobookTitle" class="form-label">Title</label>
                  <input type="text" class="form-control" id="audiobookTitle" name="title" required>
                </div>
                <div class="mb-3">
                  <label for="audiobookAuthor" class="form-label">Author</label>
                  <input type="text" class="form-control" id="audiobookAuthor" name="author" required>
                </div>
                <input type="hidden" id="audiobookCoverUrl" name="cover_url">
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-primary" id="submitAudiobook">Create Audiobook</button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('[data-utc-date]').forEach(function(cell) {
                const utcDateString = cell.getAttribute('data-utc-date');
                if (utcDateString) {
                    const date = new Date(utcDateString);
                    const options = {
                        year: 'numeric', month: 'numeric', day: 'numeric',
                        hour: 'numeric', minute: 'numeric', hour12: true
                    };
                    cell.textContent = date.toLocaleString(undefined, options);
                } else {
                    cell.textContent = 'N/A';
                }
            });
        });

        const createAudiobookBtn = document.getElementById('createAudiobookBtn');
        const audiobookModal = new bootstrap.Modal(document.getElementById('audiobookModal'));
        const mainForm = document.getElementById('mainForm');
        
        createAudiobookBtn.addEventListener('click', async () => {
            const checkedFiles = document.querySelectorAll('input.file-checkbox:checked');
            if (checkedFiles.length === 0) {
                alert('Please select at least one MP3 file to create an audiobook.');
                return;
            }
            audiobookModal.show();
            document.getElementById('metadataSpinner').style.display = 'block';
            document.getElementById('metadataForm').style.display = 'none';
            document.getElementById('audiobookCover').style.display = 'none';
            const filenames = Array.from(checkedFiles).map(cb => cb.value);
            try {
                const response = await fetch('/get-book-metadata', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ filenames: filenames })
                });
                if (!response.ok) throw new Error('Failed to fetch metadata.');
                const data = await response.json();
                document.getElementById('audiobookTitle').value = data.title || '';
                document.getElementById('audiobookAuthor').value = data.author || '';
                document.getElementById('audiobookCoverUrl').value = data.cover_url || '';
                const coverImg = document.getElementById('audiobookCover');
                if (data.cover_url) {
                    coverImg.src = data.cover_url;
                    coverImg.style.display = 'block';
                }
            } catch (error) {
                console.error('Error fetching metadata:', error);
                document.getElementById('audiobookTitle').value = '';
                document.getElementById('audiobookAuthor').value = '';
                document.getElementById('audiobookCoverUrl').value = '';
            } finally {
                document.getElementById('metadataSpinner').style.display = 'none';
                document.getElementById('metadataForm').style.display = 'block';
            }
        });

        document.getElementById('submitAudiobook').addEventListener('click', () => {
            // Disable delete checkboxes to prevent submission conflict
            document.querySelectorAll('input.delete-checkbox').forEach(cb => cb.disabled = true);
            mainForm.action = "{{ url_for('create_audiobook') }}";
            
            const title = document.getElementById('audiobookTitle').value;
            const author = document.getElementById('audiobookAuthor').value;
            const coverUrl = document.getElementById('audiobookCoverUrl').value;
            
            let titleInput = document.createElement('input');
            titleInput.type = 'hidden'; titleInput.name = 'title'; titleInput.value = title;
            mainForm.appendChild(titleInput);
            
            let authorInput = document.createElement('input');
            authorInput.type = 'hidden'; authorInput.name = 'author'; authorInput.value = author;
            mainForm.appendChild(authorInput);

            let coverUrlInput = document.createElement('input');
            coverUrlInput.type = 'hidden'; coverUrlInput.name = 'cover_url'; coverUrlInput.value = coverUrl;
            mainForm.appendChild(coverUrlInput);
            
            mainForm.submit();
        });

        document.getElementById('deleteBtn').addEventListener('click', function() {
            const checkedDeleteBoxes = document.querySelectorAll('input.delete-checkbox:checked');
            if (checkedDeleteBoxes.length === 0) {
                alert('Please select at least one item to delete.');
                return;
            }
            if (confirm(`Are you sure you want to delete the selected item(s) and their associated files? This action is permanent and only deletes the files explicitly selected.`)) {
                // Disable merge checkboxes to prevent submission conflict
                document.querySelectorAll('input.file-checkbox').forEach(cb => cb.disabled = true);
                mainForm.action = "{{ url_for('delete_bulk') }}";
                mainForm.submit();
            }
        });

        document.getElementById('selectAll').addEventListener('click', function(event) {
            document.querySelectorAll('input.file-checkbox, input.delete-checkbox').forEach(checkbox => {
                checkbox.checked = event.target.checked;
            });
        });
    </script>
</body>
</html>
